<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sesli Sohbet ve Ekran Payla≈üƒ±mƒ±</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: #000;
            color: #fff;
            overflow-x: hidden;
        }
        .container {
            display: flex;
            flex-direction: column;
            max-width: 1400px;
            margin: 10px auto;
            height: calc(100vh - 20px);
        }
        @media (min-width: 768px) {
            .container {
                flex-direction: row;
            }
        }
        #sidebar {
            width: 100%;
            max-width: 300px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        @media (min-width: 768px) {
            #sidebar {
                width: 300px;
            }
        }
        #main {
            flex: 1;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        #chatArea {
            width: 100%;
            max-width: 800px;
            height: 50vh;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            overflow-y: auto;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            transition: height 0.3s;
        }
        #chatArea.stream-active {
            height: 30vh;
        }
        @media (min-width: 768px) {
            #chatArea {
                height: 80vh;
            }
            #chatArea.stream-active {
                height: 40vh;
            }
        }
        #streamArea {
            display: none;
            width: 100%;
            max-width: 800px;
            height: 30vh;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 5px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        @media (min-width: 768px) {
            #streamArea {
                height: 40vh;
            }
        }
        #streamArea video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 10px;
        }
        #streamArea.fullscreen video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 2000;
            background: #000;
        }
        .stream-controls {
            position: absolute;
            bottom: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
        }
        .stream-control-icon {
            font-size: 16px;
            color: #fff;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s;
        }
        .stream-control-icon:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        #chatInputArea {
            width: 100%;
            max-width: 800px;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }
        #chatInput {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px 0 0 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        #chatSendBtn {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            transition: background 0.3s;
        }
        #chatSendBtn:hover {
            background: #45a049;
        }
        .file-btn {
            padding: 8px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .file-btn:hover {
            background: #1e88e5;
        }
        .chat-message {
            margin: 5px 0;
            padding: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-message .username {
            padding: 5px 8px;
            border-radius: 15px;
            font-weight: bold;
            margin-right: 8px;
        }
        .chat-message .timestamp {
            font-size: 0.7em;
            color: #ccc;
        }
        .chat-message img {
            max-width: 150px;
            max-height: 150px;
            border-radius: 5px;
            margin-top: 5px;
        }
        .chat-message a {
            color: #4CAF50;
            text-decoration: none;
        }
        #userList {
            flex: 1;
            overflow-y: auto;
        }
        #userList div {
            margin: 5px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.3s;
            position: relative;
            cursor: pointer;
        }
        #userList div:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        #login {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            text-align: center;
            width: 90%;
            max-width: 300px;
        }
        input {
            padding: 8px;
            margin: 8px;
            width: 100%;
            max-width: 200px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        .status-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin: 0 3px;
            text-align: center;
            line-height: 16px;
            border-radius: 50%;
            font-size: 12px;
        }
        .mic-on { background-color: #4CAF50; }
        .mic-off { background-color: #ff4444; }
        .screen-on { background-color: #4CAF50; }
        .screen-off { background-color: #ff4444; }
        .control-icons {
            display: flex;
            gap: 8px;
            padding: 8px 0;
        }
        .control-icon {
            font-size: 20px;
            color: #fff;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 50%;
            transition: background 0.3s;
        }
        .control-icon.active {
            background: #4CAF50;
        }
        .control-icon:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .popup {
            display: none;
            position: absolute;
            bottom: 50px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            color: #fff;
            width: 90%;
            max-width: 260px;
        }
        .popup select, .popup input {
            width: 100%;
            padding: 5px;
            margin: 5px 0;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        .popup button {
            width: 100%;
            padding: 8px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .popup button:hover {
            background: #45a049;
        }
        .user-options {
            display: none;
            position: absolute;
            top: 40px;
            left: 0;
            background: rgba(0, 0, 0, 0.95);
            padding: 8px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            width: 180px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .user-options .option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            margin: 3px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .user-options .option:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .user-options .option span {
            font-size: 16px;
        }
        .user-options input[type="range"] {
            width: 100%;
            margin: 3px 0;
        }
    </style>
</head>
<body>
    <div id="login">
        <h2>Kullanƒ±cƒ± Adƒ± Gir</h2>
        <input type="text" id="username" placeholder="Kullanƒ±cƒ± adƒ±n" required>
        <button onclick="join()" style="background: #4CAF50;">Katƒ±l</button>
    </div>
    <div class="container" id="app" style="display: none;">
        <div id="sidebar">
            <div>
                <h3>Kullanƒ±cƒ±lar</h3>
                <div id="userList"></div>
            </div>
            <div class="control-icons">
                <span id="audioIcon" class="control-icon" onclick="toggleAudio()">üé§</span>
                <span id="streamIcon" class="control-icon" onclick="toggleStream()">üìπ</span>
            </div>
            <div id="audioPopup" class="popup">
                <h4>Ses Ayarlarƒ±</h4>
                <label>Giri≈ü Cihazƒ±:</label>
                <select id="audioInputDevice"></select>
                <label>√áƒ±kƒ±≈ü Cihazƒ±:</label>
                <select id="audioOutputDevice"></select>
                <label>G√ºr√ºlt√º Engelleme:</label>
                <input type="checkbox" id="noiseSuppression">
                <button onclick="applyAudioSettings()">Uygula</button>
            </div>
            <div id="streamPopup" class="popup">
                <h4>Yayƒ±n Ayarlarƒ±</h4>
                <label>Yayƒ±n T√ºr√º:</label>
                <select id="streamType">
                    <option value="camera">Kamera</option>
                    <option value="screen">Ekran Payla≈üƒ±mƒ± (Yalnƒ±zca PC)</option>
                </select>
                <label>G√∂r√ºnt√º Kalitesi:</label>
                <select id="streamQuality">
                    <option value="480p">480p</option>
                    <option value="720p">720p</option>
                    <option value="1080p">1080p</option>
                </select>
                <label>Kare Hƒ±zƒ±:</label>
                <select id="frameRate">
                    <option value="30">30 FPS</option>
                    <option value="60">60 FPS</option>
                </select>
                <button onclick="applyStreamSettings()">Yayƒ±nƒ± Ba≈ülat</button>
            </div>
        </div>
        <div id="main">
            <div id="streamArea">
                <video id="streamVideo" autoplay playsinline controls muted></video>
                <div class="stream-controls">
                    <span class="stream-control-icon" onclick="toggleStreamMute()">üîä</span>
                    <span class="stream-control-icon" onclick="toggleFullscreen()">‚õ∂</span>
                </div>
            </div>
            <div id="chatArea"></div>
            <div id="chatInputArea">
                <input type="text" id="chatInput" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." onkeypress="if(event.key === 'Enter') sendChatMessage()">
                <button class="file-btn" onclick="document.getElementById('fileInput').click()">üìé</button>
                <button class="file-btn" onclick="document.getElementById('photoInput').click()">üì∑</button>
                <input type="file" id="fileInput" style="display: none;" onchange="sendFile(this.files[0])">
                <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="sendPhoto(this.files[0])">
                <button id="chatSendBtn" onclick="sendChatMessage()">G√∂nder</button>
            </div>
        </div>
    </div>

    <script>
        let localStream;
        let peerConnections = new Map();
        let ws;
        let myId;
        let mutedUsers = new Set();
        let streamPeerConnection = null;
        let usernameColors = {};
        let pendingOffers = new Map();
        let isStreamMuted = true;
        let isAudioActive = false;
        let isStreamActive = false;
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' },
                {
                    urls: 'turn:relay1.expressturn.com:3478',
                    username: 'efW5J7X8J9K2L3',
                    credential: '8J9K2L3M4N5P6'
                }
            ]
        };

        const userList = document.getElementById('userList');
        const streamArea = document.getElementById('streamArea');
        const streamVideo = document.getElementById('streamVideo');
        const chatArea = document.getElementById('chatArea');
        const audioIcon = document.getElementById('audioIcon');
        const streamIcon = document.getElementById('streamIcon');

        const wsUrl = `${location.protocol === 'https:' ? 'wss:' : 'ws:'}//${location.host}`;
        ws = new WebSocket(wsUrl);
        ws.onopen = () => console.log('WebSocket baƒülandƒ±:', wsUrl);
        ws.onmessage = handleSignaling;
        ws.onerror = (error) => console.error('WebSocket hatasƒ±:', error);
        ws.onclose = () => console.log('WebSocket baƒülantƒ±sƒ± kapandƒ±');

        function join() {
            const username = document.getElementById('username').value.trim();
            if (username) {
                ws.send(JSON.stringify({ type: 'join', username }));
                document.getElementById('login').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                // Medya izinlerini kontrol et
                navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                    .then(() => console.log('Mikrofon izinleri alƒ±ndƒ±'))
                    .catch(err => console.error('Mikrofon izinleri alƒ±namadƒ±:', err));
            } else {
                alert('L√ºtfen bir kullanƒ±cƒ± adƒ± gir!');
            }
        }

        function getRandomColor(username) {
            if (!usernameColors[username]) {
                const colors = ['#FF6F61', '#6B5B95', '#88B04B', '#F7CAC9', '#92A8D1', '#955251', '#B565A7'];
                usernameColors[username] = colors[Object.keys(usernameColors).length % colors.length];
            }
            return usernameColors[username];
        }

        async function toggleAudio() {
            if (isAudioActive) {
                // Ses akƒ±≈üƒ±nƒ± kapat
                if (localStream) {
                    localStream.getAudioTracks().forEach(track => track.stop());
                    localStream = null;
                }
                ws.send(JSON.stringify({ type: 'toggleAudio', id: myId, state: false }));
                isAudioActive = false;
                audioIcon.classList.remove('active');
            } else {
                // Ses ayarlarƒ± popup'ƒ±nƒ± a√ß
                toggleAudioPopup();
            }
        }

        async function toggleStream() {
            if (isStreamActive) {
                // Yayƒ±n akƒ±≈üƒ±nƒ± kapat
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                ws.send(JSON.stringify({ type: 'toggleStream', id: myId, state: false }));
                isStreamActive = false;
                streamIcon.classList.remove('active');
            } else {
                // Yayƒ±n ayarlarƒ± popup'ƒ±nƒ± a√ß
                toggleStreamPopup();
            }
        }

        async function toggleAudioPopup() {
            const popup = document.getElementById('audioPopup');
            popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
            if (popup.style.display === 'block') {
                await populateAudioDevices();
            }
        }

        async function toggleStreamPopup() {
            const popup = document.getElementById('streamPopup');
            popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
        }

        async function populateAudioDevices() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioInputSelect = document.getElementById('audioInputDevice');
                const audioOutputSelect = document.getElementById('audioOutputDevice');

                audioInputSelect.innerHTML = '';
                audioOutputSelect.innerHTML = '';

                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Cihaz ${device.deviceId}`;
                    if (device.kind === 'audioinput') {
                        audioInputSelect.appendChild(option);
                    } else if (device.kind === 'audiooutput') {
                        audioOutputSelect.appendChild(option);
                    }
                });
            } catch (error) {
                console.error('Cihaz listesi alƒ±namadƒ±:', error);
                alert('Cihaz listesi alƒ±namadƒ±. L√ºtfen tarayƒ±cƒ± izinlerini kontrol edin.');
            }
        }

        async function applyAudioSettings() {
            const audioInputDevice = document.getElementById('audioInputDevice').value;
            const audioOutputDevice = document.getElementById('audioOutputDevice').value;
            const noiseSuppression = document.getElementById('noiseSuppression').checked;

            try {
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        deviceId: audioInputDevice ? { exact: audioInputDevice } : undefined,
                        noiseSuppression: noiseSuppression,
                        echoCancellation: true,
                        autoGainControl: true
                    }
                });
                console.log('Ses akƒ±≈üƒ± ba≈ülatƒ±ldƒ±:', localStream.getTracks());
                ws.send(JSON.stringify({ type: 'toggleAudio', id: myId, state: true }));
                document.getElementById('audioPopup').style.display = 'none';
                isAudioActive = true;
                audioIcon.classList.add('active');

                if (streamVideo.srcObject) {
                    streamVideo.setSinkId(audioOutputDevice).catch(err => console.error('√áƒ±kƒ±≈ü cihazƒ± ayarlama hatasƒ±:', err));
                }

                peerConnections.forEach((pc, peerId) => {
                    if (pc.signalingState === 'stable') {
                        localStream.getTracks().forEach(track => {
                            const sender = pc.getSenders().find(s => s.track && s.track.kind === track.kind);
                            if (sender) {
                                sender.replaceTrack(track);
                            } else {
                                pc.addTrack(track, localStream);
                            }
                        });
                    }
                });
            } catch (error) {
                console.error('Ses hatasƒ±:', error);
                alert('Mikrofon eri≈üiminde bir hata olu≈ütu. L√ºtfen cihaz izinlerini kontrol edin ve tarayƒ±cƒ±nƒ±zƒ±n mikrofon eri≈üimine izin verdiƒüinden emin olun.');
            }
        }

        async function applyStreamSettings() {
            const streamType = document.getElementById('streamType').value;
            const streamQuality = document.getElementById('streamQuality').value;
            const frameRate = parseInt(document.getElementById('frameRate').value);

            const constraints = {
                video: {
                    width: streamQuality === '480p' ? 640 : streamQuality === '720p' ? 1280 : 1920,
                    height: streamQuality === '480p' ? 480 : streamQuality === '720p' ? 720 : 1080,
                    frameRate: frameRate
                },
                audio: true
            };

            try {
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
                if (streamType === 'screen' && !navigator.mediaDevices.getDisplayMedia) {
                    throw new Error('Ekran payla≈üƒ±mƒ± bu cihazda desteklenmiyor.');
                }
                const stream = streamType === 'screen'
                    ? await navigator.mediaDevices.getDisplayMedia(constraints)
                    : await navigator.mediaDevices.getUserMedia(constraints);
                localStream = stream;
                console.log('Yayƒ±n akƒ±≈üƒ± ba≈ülatƒ±ldƒ±:', localStream.getTracks());
                ws.send(JSON.stringify({ type: 'toggleStream', id: myId, state: true }));
                document.getElementById('streamPopup').style.display = 'none';
                isStreamActive = true;
                streamIcon.classList.add('active');

                peerConnections.forEach((pc, peerId) => {
                    if (pc.signalingState === 'stable') {
                        localStream.getTracks().forEach(track => {
                            const sender = pc.getSenders().find(s => s.track && s.track.kind === track.kind);
                            if (sender) {
                                sender.replaceTrack(track);
                            } else {
                                pc.addTrack(track, localStream);
                            }
                        });
                    }
                });
            } catch (error) {
                console.error('Yayƒ±n hatasƒ±:', error);
                alert('Yayƒ±n ba≈ülatƒ±lamadƒ±. L√ºtfen tarayƒ±cƒ±nƒ±zƒ±n kamera veya ekran payla≈üƒ±mƒ±na izin verdiƒüinden emin olun. Not: iOS Safari ekran payla≈üƒ±mƒ±nƒ± desteklemez, l√ºtfen Chrome kullanmayƒ± deneyin veya kamera se√ßeneƒüini se√ßin.');
            }
        }

        function handleSignaling(event) {
            const data = JSON.parse(event.data);
            console.log('Gelen sinyal:', data);

            if (data.type === 'id') {
                myId = data.id;
                console.log('Benim ID:', myId);
            } else if (data.type === 'userList') {
                updateUserList(data.users);
            } else if (data.type === 'offer') {
                if (pendingOffers.has(data.from)) {
                    console.log(`Zaten bir offer i≈üleniyor (${data.from}), bu offer atlanƒ±yor.`);
                    return;
                }
                pendingOffers.set(data.from, true);
                handleOffer(data.offer, data.from);
            } else if (data.type === 'answer') {
                handleAnswer(data.from, data.answer);
            } else if (data.type === 'candidate') {
                handleCandidate(data.from, data.candidate);
            } else if (data.type === 'requestStream') {
                if (localStream && localStream.getVideoTracks().length && localStream.getVideoTracks()[0].enabled) {
                    createOffer(data.from);
                } else {
                    console.log('Yayƒ±n akƒ±≈üƒ± mevcut deƒüil veya kapalƒ±.');
                }
            } else if (data.type === 'muteUser' && data.targetId === myId) {
                if (localStream && localStream.getAudioTracks().length) {
                    localStream.getAudioTracks()[0].enabled = !data.muted;
                }
            } else if (data.type === 'volumeChange' && data.targetId === myId) {
                if (streamVideo.srcObject) {
                    streamVideo.volume = data.volume;
                }
            } else if (data.type === 'chatMessage') {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message';
                messageDiv.innerHTML = `
                    <div>
                        <span class="username" style="background: ${getRandomColor(data.username)}">${data.username}</span>
                        ${data.message}
                    </div>
                    <span class="timestamp">${data.timestamp}</span>
                `;
                chatArea.appendChild(messageDiv);
                chatArea.scrollTop = chatArea.scrollHeight;
            } else if (data.type === 'fileMessage') {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message';
                if (data.fileType.startsWith('image/')) {
                    messageDiv.innerHTML = `
                        <div>
                            <span class="username" style="background: ${getRandomColor(data.username)}">${data.username}</span>
                            <br>
                            <img src="${data.fileData}" alt="${data.fileName}">
                        </div>
                        <span class="timestamp">${data.timestamp}</span>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div>
                            <span class="username" style="background: ${getRandomColor(data.username)}">${data.username}</span>
                            <br>
                            <a href="${data.fileData}" download="${data.fileName}">${data.fileName}</a>
                        </div>
                        <span class="timestamp">${data.timestamp}</span>
                    `;
                }
                chatArea.appendChild(messageDiv);
                chatArea.scrollTop = chatArea.scrollHeight;
            }
        }

        function updateUserList(users) {
            userList.innerHTML = '';
            users.forEach(user => {
                const div = document.createElement('div');
                div.dataset.id = user.id;
                div.innerHTML = `
                    ${user.username}
                    <span class="status-icon ${user.audio ? 'mic-on' : 'mic-off'}">üé§</span>
                    <span class="status-icon ${user.stream ? 'screen-on' : 'screen-off'}">üìπ</span>
                    <div class="user-options" id="options-${user.id}">
                        <div class="option" onclick="muteUser(${user.id})">
                            <span>${mutedUsers.has(user.id) ? 'üîä' : 'üîá'}</span>
                        </div>
                        <div class="option" onclick="document.getElementById('volume-${user.id}').style.display = 'block'">
                            <span>üîà</span>
                        </div>
                        <input type="range" id="volume-${user.id}" min="0" max="1" step="0.1" value="1" oninput="setVolume(${user.id})" style="display: none;">
                        <div class="option" onclick="requestStream(${user.id}, '${user.username}')">
                            <span>‚ñ∂Ô∏è</span>
                        </div>
                    </div>
                `;
                div.onclick = (e) => {
                    const options = document.getElementById(`options-${user.id}`);
                    options.style.display = options.style.display === 'block' ? 'none' : 'block';
                };
                userList.appendChild(div);
            });
            console.log('Kullanƒ±cƒ± listesi g√ºncellendi:', users);
        }

        async function createOffer(to) {
            try {
                if (peerConnections.has(to) && peerConnections.get(to).signalingState !== 'closed') {
                    console.log(`Zaten bir baƒülantƒ± var (${to}), mevcut baƒülantƒ± kullanƒ±lƒ±yor.`);
                    return;
                }

                const pc = new RTCPeerConnection(configuration);
                peerConnections.set(to, pc);

                localStream.getTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                    console.log(`Track eklendi (${to}):`, track);
                });

                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        ws.send(JSON.stringify({ type: 'candidate', candidate: event.candidate, to }));
                        console.log('ICE candidate g√∂nderildi:', to, event.candidate);
                    }
                };

                pc.ontrack = (event) => {
                    console.log(`Yeni track alƒ±ndƒ± (${to}):`, event.streams[0].getTracks());
                    if (streamPeerConnection === pc) {
                        streamVideo.srcObject = event.streams[0];
                        streamArea.style.display = 'block';
                        chatArea.classList.add('stream-active');
                        streamVideo.play().catch(err => console.error('Video oynatma hatasƒ±:', err));
                    }
                };

                pc.oniceconnectionstatechange = () => {
                    console.log(`ICE connection state (${to}):`, pc.iceConnectionState);
                    if (pc.iceConnectionState === 'failed') {
                        console.error('ICE baƒülantƒ±sƒ± ba≈üarƒ±sƒ±z oldu:', to);
                        pc.restartIce();
                    }
                };

                pc.onicegatheringstatechange = () => {
                    console.log(`ICE gathering state (${to}):`, pc.iceGatheringState);
                };

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                ws.send(JSON.stringify({ type: 'offer', offer, from: myId, to }));
            } catch (error) {
                console.error('Offer olu≈üturma hatasƒ±:', error);
            }
        }

        async function handleOffer(offer, from) {
            try {
                if (peerConnections.has(from) && peerConnections.get(from).signalingState !== 'closed') {
                    console.log(`Zaten bir baƒülantƒ± var (${from}), mevcut baƒülantƒ± kullanƒ±lƒ±yor.`);
                    return;
                }

                const pc = new RTCPeerConnection(configuration);
                peerConnections.set(from, pc);
                streamPeerConnection = pc;

                await pc.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                ws.send(JSON.stringify({ type: 'answer', answer, from: myId, to: from }));

                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        ws.send(JSON.stringify({ type: 'candidate', candidate: event.candidate, to: from }));
                        console.log('ICE candidate g√∂nderildi:', from, event.candidate);
                    }
                };

                pc.ontrack = (event) => {
                    console.log(`Yeni track alƒ±ndƒ± (${from}):`, event.streams[0].getTracks());
                    streamVideo.srcObject = event.streams[0];
                    streamArea.style.display = 'block';
                    chatArea.classList.add('stream-active');
                    streamVideo.play().catch(err => console.error('Video oynatma hatasƒ±:', err));
                };

                pc.oniceconnectionstatechange = () => {
                    console.log(`ICE connection state (${from}):`, pc.iceConnectionState);
                    if (pc.iceConnectionState === 'failed') {
                        console.error('ICE baƒülantƒ±sƒ± ba≈üarƒ±sƒ±z oldu:', from);
                        pc.restartIce();
                    }
                };

                pc.onicegatheringstatechange = () => {
                    console.log(`ICE gathering state (${from}):`, pc.iceGatheringState);
                };

                pendingOffers.delete(from);
            } catch (error) {
                console.error('Offer i≈üleme hatasƒ±:', error);
                pendingOffers.delete(from);
            }
        }

        async function handleAnswer(from, answer) {
            const pc = peerConnections.get(from);
            if (pc && pc.signalingState === 'have-local-offer') {
                try {
                    await pc.setRemoteDescription(new RTCSessionDescription(answer));
                } catch (error) {
                    console.error('Answer i≈üleme hatasƒ±:', error);
                }
            } else {
                console.log(`Answer i≈ülenemedi, baƒülantƒ± durumu uygun deƒüil (${from}):`, pc ? pc.signalingState : 'Baƒülantƒ± yok');
            }
        }

        async function handleCandidate(from, candidate) {
            const pc = peerConnections.get(from);
            if (pc) {
                try {
                    await pc.addIceCandidate(new RTCIceCandidate(candidate));
                } catch (error) {
                    console.error('Candidate i≈üleme hatasƒ±:', error);
                }
            }
        }

        function requestStream(targetId, username) {
            if (streamPeerConnection) {
                streamPeerConnection.close();
                peerConnections.delete(targetId);
                streamPeerConnection = null;
            }
            streamVideo.srcObject = null;
            streamArea.style.display = 'none';
            chatArea.classList.remove('stream-active');
            ws.send(JSON.stringify({ type: 'requestStream', to: targetId, from: myId }));
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                streamArea.classList.add('fullscreen');
                streamVideo.requestFullscreen().catch(err => console.error('Tam ekran hatasƒ±:', err));
            } else {
                streamArea.classList.remove('fullscreen');
                document.exitFullscreen();
            }
        }

        function toggleStreamMute() {
            isStreamMuted = !isStreamMuted;
            streamVideo.muted = isStreamMuted;
            const muteIcon = document.querySelector('.stream-controls .stream-control-icon:first-child');
            muteIcon.textContent = isStreamMuted ? 'üîá' : 'üîä';
        }

        function muteUser(targetId) {
            if (mutedUsers.has(targetId)) {
                mutedUsers.delete(targetId);
            } else {
                mutedUsers.add(targetId);
            }
            ws.send(JSON.stringify({ type: 'muteUser', targetId, muted: mutedUsers.has(targetId) }));
        }

        function setVolume(targetId) {
            const volume = document.getElementById(`volume-${targetId}`).value;
            ws.send(JSON.stringify({ type: 'volumeChange', targetId, volume: parseFloat(volume) }));
        }

        function sendChatMessage() {
            const message = document.getElementById('chatInput').value.trim();
            if (message) {
                ws.send(JSON.stringify({ type: 'chatMessage', username: document.getElementById('username').value, message }));
                document.getElementById('chatInput').value = '';
            }
        }

        function sendFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const fileData = event.target.result;
                ws.send(JSON.stringify({
                    type: 'fileMessage',
                    username: document.getElementById('username').value,
                    fileName: file.name,
                    fileData: fileData,
                    fileType: file.type
                }));
            };
            reader.readAsDataURL(file);
        }

        function sendPhoto(photo) {
            if (!photo) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const fileData = event.target.result;
                ws.send(JSON.stringify({
                    type: 'fileMessage',
                    username: document.getElementById('username').value,
                    fileName: photo.name,
                    fileData: fileData,
                    fileType: photo.type
                }));
            };
            reader.readAsDataURL(photo);
        }

        function stopStreams() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            peerConnections.forEach(pc => pc.close());
            peerConnections.clear();
            ws.send(JSON.stringify({ type: 'toggleAudio', id: myId, state: false }));
            ws.send(JSON.stringify({ type: 'toggleStream', id: myId, state: false }));
            streamArea.style.display = 'none';
            chatArea.classList.remove('stream-active');
            isAudioActive = false;
            isStreamActive = false;
            audioIcon.classList.remove('active');
            streamIcon.classList.remove('active');
        }
    </script>
</body>
</html>
