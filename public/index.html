<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Sesli Sohbet ve Ekran PaylaÅŸÄ±mÄ±</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f0f0; }
        .container { display: flex; max-width: 1200px; margin: 0 auto; }
        #sidebar { width: 250px; padding: 10px; background: #fff; border-radius: 5px; }
        #main { flex: 1; padding: 0 20px; }
        video { width: 100%; max-width: 600px; background-color: black; margin: 10px 0; }
        button { padding: 8px 16px; margin: 5px; color: white; border: none; cursor: pointer; }
        .inactive { background-color: #ff4444; }
        .active { background-color: #4CAF50; }
        button:hover { filter: brightness(90%); }
        #controls { margin: 20px 0; }
        #userList div { margin: 5px 0; display: flex; align-items: center; justify-content: space-between; }
        #login { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        input { padding: 5px; margin: 5px; width: 200px; }
        .video-container { position: relative; }
        .fullscreen-btn { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); }
        .status-icon { display: inline-block; width: 20px; height: 20px; margin: 0 5px; text-align: center; line-height: 20px; border-radius: 50%; }
        .mic-on { background-color: #4CAF50; }
        .mic-off { background-color: #ff4444; }
        .screen-on { background-color: #4CAF50; }
        .screen-off { background-color: #ff4444; }
    </style>
</head>
<body>
    <div id="login">
        <h2>KullanÄ±cÄ± AdÄ± Gir</h2>
        <input type="text" id="username" placeholder="KullanÄ±cÄ± adÄ±n" required>
        <button onclick="join()">KatÄ±l</button>
    </div>
    <div class="container" id="app" style="display: none;">
        <div id="sidebar">
            <h3>KullanÄ±cÄ±lar</h3>
            <div id="userList"></div>
        </div>
        <div id="main">
            <h1>Sesli Sohbet ve Ekran PaylaÅŸÄ±mÄ±</h1>
            <div id="controls">
                <button id="audioBtn" class="inactive" onclick="toggleAudio()">Ses: <span id="audioState">KapalÄ±</span></button>
                <button id="streamBtn" class="inactive" onclick="toggleStream()">YayÄ±n: <span id="streamState">KapalÄ±</span></button>
                <button id="stopBtn" class="inactive" onclick="stopStreams()">Durdur</button>
            </div>
            <div class="video-container">
                <video id="localVideo" autoplay playsinline muted></video>
            </div>
            <div id="remoteVideos"></div>
        </div>
    </div>

    <script>
        let localStream;
        let peerConnections = new Map();
        let ws;
        let myId;
        let mutedUsers = new Set();
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                {
                    urls: 'turn:turn.anyfirewall.com:443?transport=tcp',
                    username: 'webrtc',
                    credential: 'webrtc'
                }
            ]
        };

        const localVideo = document.getElementById('localVideo');
        const remoteVideos = document.getElementById('remoteVideos');
        const userList = document.getElementById('userList');
        const audioBtn = document.getElementById('audioBtn');
        const streamBtn = document.getElementById('streamBtn');

        const wsUrl = `${location.protocol === 'https:' ? 'wss:' : 'ws:'}//${location.host}`;
        ws = new WebSocket(wsUrl);
        ws.onopen = () => console.log('WebSocket baÄŸlandÄ±:', wsUrl);
        ws.onmessage = handleSignaling;
        ws.onerror = (error) => console.error('WebSocket hatasÄ±:', error);
        ws.onclose = () => console.log('WebSocket baÄŸlantÄ±sÄ± kapandÄ±');

        function join() {
            const username = document.getElementById('username').value.trim();
            if (username) {
                ws.send(JSON.stringify({ type: 'join', username }));
                document.getElementById('login').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
            } else {
                alert('LÃ¼tfen bir kullanÄ±cÄ± adÄ± gir!');
            }
        }

        async function toggleAudio() {
            try {
                if (!localStream || !localStream.getAudioTracks().length) {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    localVideo.srcObject = localStream;
                    console.log('Ses akÄ±ÅŸÄ± baÅŸlatÄ±ldÄ±:', localStream.getAudioTracks());
                    broadcastStream();
                }
                const enabled = !localStream.getAudioTracks()[0].enabled;
                localStream.getAudioTracks()[0].enabled = enabled;
                document.getElementById('audioState').textContent = enabled ? 'AÃ§Ä±k' : 'KapalÄ±';
                audioBtn.className = enabled ? 'active' : 'inactive';
                ws.send(JSON.stringify({ type: 'toggleAudio', id: myId, state: enabled }));
            } catch (error) {
                console.error('Ses hatasÄ±:', error);
            }
        }

        async function toggleStream() {
            try {
                if (!localStream || !localStream.getVideoTracks().length) {
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    if (localStream) {
                        localStream.addTrack(screenStream.getVideoTracks()[0]);
                    } else {
                        localStream = screenStream;
                    }
                    localVideo.srcObject = localStream;
                    console.log('YayÄ±n akÄ±ÅŸÄ± baÅŸlatÄ±ldÄ±:', localStream.getVideoTracks());
                    broadcastStream();
                }
                const enabled = !localStream.getVideoTracks()[0].enabled;
                localStream.getVideoTracks()[0].enabled = enabled;
                document.getElementById('streamState').textContent = enabled ? 'AÃ§Ä±k' : 'KapalÄ±';
                streamBtn.className = enabled ? 'active' : 'inactive';
                ws.send(JSON.stringify({ type: 'toggleStream', id: myId, state: enabled }));
            } catch (error) {
                console.error('YayÄ±n hatasÄ±:', error);
            }
        }

        function broadcastStream() {
            const otherUsers = [...userList.children].map(div => parseInt(div.dataset.id)).filter(id => id !== myId);
            console.log('YayÄ±n diÄŸer kullanÄ±cÄ±lara gÃ¶nderiliyor:', otherUsers);
            otherUsers.forEach(id => createOffer(id));
        }

        function handleSignaling(event) {
            const data = JSON.parse(event.data);
            console.log('Gelen sinyal:', data);

            if (data.type === 'id') {
                myId = data.id;
                console.log('Benim ID:', myId);
            } else if (data.type === 'userList') {
                updateUserList(data.users);
            } else if (data.type === 'offer') {
                handleOffer(data.offer, data.from);
            } else if (data.type === 'answer') {
                handleAnswer(data.from, data.answer);
            } else if (data.type === 'candidate') {
                handleCandidate(data.from, data.candidate);
            } else if (data.type === 'muteUser' && data.targetId === myId) {
                if (localStream && localStream.getAudioTracks().length) {
                    localStream.getAudioTracks()[0].enabled = !data.muted;
                }
            }
        }

        async function createOffer(to) {
            try {
                const pc = new RTCPeerConnection(configuration);
                peerConnections.set(to, pc);
                localStream.getTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                    console.log(`Track eklendi (${to}):`, track);
                });

                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        ws.send(JSON.stringify({ type: 'candidate', candidate: event.candidate, to }));
                        console.log('ICE candidate gÃ¶nderildi:', to, event.candidate);
                    }
                };

                pc.ontrack = (event) => {
                    console.log(`Yeni track alÄ±ndÄ± (${to}):`, event.streams[0].getTracks());
                    if (!mutedUsers.has(to)) {
                        let container = document.getElementById(`remote-container-${to}`);
                        if (!container) {
                            container = document.createElement('div');
                            container.className = 'video-container';
                            container.id = `remote-container-${to}`;
                            const video = document.createElement('video');
                            video.id = `remote-${to}`;
                            video.autoplay = true;
                            video.playsinline = true;
                            const fullscreenBtn = document.createElement('button');
                            fullscreenBtn.className = 'fullscreen-btn';
                            fullscreenBtn.textContent = 'Tam Ekran';
                            fullscreenBtn.onclick = () => toggleFullscreen(video);
                            container.appendChild(video);
                            container.appendChild(fullscreenBtn);
                            remoteVideos.appendChild(container);
                        }
                        container.querySelector(`#remote-${to}`).srcObject = event.streams[0];
                    }
                };

                pc.oniceconnectionstatechange = () => {
                    console.log(`ICE connection state (${to}):`, pc.iceConnectionState);
                    if (pc.iceConnectionState === 'failed') {
                        console.error('ICE baÄŸlantÄ±sÄ± baÅŸarÄ±sÄ±z oldu:', to);
                    }
                };

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                ws.send(JSON.stringify({ type: 'offer', offer, from: myId, to }));
            } catch (error) {
                console.error('Offer oluÅŸturma hatasÄ±:', error);
            }
        }

        async function handleOffer(offer, from) {
            try {
                const pc = new RTCPeerConnection(configuration);
                peerConnections.set(from, pc);
                await pc.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                ws.send(JSON.stringify({ type: 'answer', answer, from: myId, to: from }));

                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        ws.send(JSON.stringify({ type: 'candidate', candidate: event.candidate, to: from }));
                        console.log('ICE candidate gÃ¶nderildi:', from, event.candidate);
                    }
                };

                pc.ontrack = (event) => {
                    console.log(`Yeni track alÄ±ndÄ± (${from}):`, event.streams[0].getTracks());
                    if (!mutedUsers.has(from)) {
                        let container = document.getElementById(`remote-container-${from}`);
                        if (!container) {
                            container = document.createElement('div');
                            container.className = 'video-container';
                            container.id = `remote-container-${from}`;
                            const video = document.createElement('video');
                            video.id = `remote-${from}`;
                            video.autoplay = true;
                            video.playsinline = true;
                            const fullscreenBtn = document.createElement('button');
                            fullscreenBtn.className = 'fullscreen-btn';
                            fullscreenBtn.textContent = 'Tam Ekran';
                            fullscreenBtn.onclick = () => toggleFullscreen(video);
                            container.appendChild(video);
                            container.appendChild(fullscreenBtn);
                            remoteVideos.appendChild(container);
                        }
                        container.querySelector(`#remote-${from}`).srcObject = event.streams[0];
                    }
                };

                pc.oniceconnectionstatechange = () => {
                    console.log(`ICE connection state (${from}):`, pc.iceConnectionState);
                    if (pc.iceConnectionState === 'failed') {
                        console.error('ICE baÄŸlantÄ±sÄ± baÅŸarÄ±sÄ±z oldu:', from);
                    }
                };
            } catch (error) {
                console.error('Offer iÅŸleme hatasÄ±:', error);
            }
        }

        async function handleAnswer(from, answer) {
            const pc = peerConnections.get(from);
            if (pc) {
                try {
                    await pc.setRemoteDescription(new RTCSessionDescription(answer));
                } catch (error) {
                    console.error('Answer iÅŸleme hatasÄ±:', error);
                }
            }
        }

        async function handleCandidate(from, candidate) {
            const pc = peerConnections.get(from);
            if (pc) {
                try {
                    await pc.addIceCandidate(new RTCIceCandidate(candidate));
                } catch (error) {
                    console.error('Candidate iÅŸleme hatasÄ±:', error);
                }
            }
        }

        function updateUserList(users) {
            userList.innerHTML = '';
            users.forEach(user => {
                const div = document.createElement('div');
                div.dataset.id = user.id;
                div.innerHTML = `
                    ${user.username}
                    <span class="status-icon ${user.audio ? 'mic-on' : 'mic-off'}">ğŸ¤</span>
                    <span class="status-icon ${user.stream ? 'screen-on' : 'screen-off'}">ğŸ–¥ï¸</span>
                    <button onclick="muteUser(${user.id})">${mutedUsers.has(user.id) ? 'Sesi AÃ§' : 'Mute'}</button>
                `;
                userList.appendChild(div);
            });
            console.log('KullanÄ±cÄ± listesi gÃ¼ncellendi:', users);
            if (localStream) broadcastStream();
        }

        function muteUser(targetId) {
            if (mutedUsers.has(targetId)) {
                mutedUsers.delete(targetId);
                const video = document.getElementById(`remote-${targetId}`);
                if (video) video.muted = false;
            } else {
                mutedUsers.add(targetId);
                const video = document.getElementById(`remote-${targetId}`);
                if (video) video.muted = true;
            }
            ws.send(JSON.stringify({ type: 'muteUser', targetId, muted: mutedUsers.has(targetId) }));
        }

        function toggleFullscreen(video) {
            if (!document.fullscreenElement) {
                video.requestFullscreen().catch(err => console.error('Tam ekran hatasÄ±:', err));
            } else {
                document.exitFullscreen();
            }
        }

        function stopStreams() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localVideo.srcObject = null;
                remoteVideos.innerHTML = '';
                localStream = null;
            }
            peerConnections.forEach(pc => pc.close());
            peerConnections.clear();
            document.getElementById('audioState').textContent = 'KapalÄ±';
            document.getElementById('streamState').textContent = 'KapalÄ±';
            audioBtn.className = 'inactive';
            streamBtn.className = 'inactive';
            ws.send(JSON.stringify({ type: 'toggleAudio', id: myId, state: false }));
            ws.send(JSON.stringify({ type: 'toggleStream', id: myId, state: false }));
        }
    </script>
</body>
</html>
